<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reparametrizing a Multivariate Normal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/blog-post.css">
</head>
<body>
  <header class="main-header">
    <nav class="top-nav">
      <a href="/">Home</a>
      <a href="/blog/" class="active">Blog</a>
      <!-- <a href="/published/">Publications</a> -->
    </nav>
  </header>

<article class="blog-content">
  <h1>Reparametrizing a Multivariate Normal</h1>
  <p><strong>Posted on:</strong> March 19, 2025</p>
  <p>
    A multivariate normal \(y\in \mathbb{R}^d\) with mean \( \mu \in \mathbb{R}^d \) and covariance matrix \( \Sigma \in \mathbb{R}^{d \times d} \) is written as
  </p>
  <p>
  \begin{align}
    y &\sim \mathcal{N}(\mu, \Sigma) \label{eq-1}
  \end{align}
  </p>
  <p>
    Here, by definition, the covariance matrix is symmetric positive definite, and therefore has a unique Cholesky factorization \(\Sigma = L L^T\), where \(L \in \mathbb{R}^{d\times d}\) is a lower triangular matrix with positive diagonal entries.
  </p>
  <p>
    Now, consider
  </p>
  <p>
    \begin{align}
    z &\sim \mathcal{N}(0, I_d)
    \\[6pt]
    Lz &\sim \mathcal{N}\!\left(0, L I_d L^T\right)
    \\[6pt]
    &= \mathcal{N}\!\left(0, L L^T\right)
    \\[6pt]
    &= \mathcal{N}\!\left(0, \Sigma\right)
    \end{align}
  </p>
  <p>
    where \(I_d\) is the d-dimensional identity matrix. Therefore,
  </p>
  <p>
    \begin{align}
    \mu + Lz &\sim \mathcal{N}\!\left(\mu, \Sigma\right) \label{eq-2}
    \end{align}
  </p>
  <p>
    Hence, Eq. \eqref{eq-2} provides a reparametrization of Eq. \eqref{eq-1}.
  </p>

  <h2>Implementation in NumPyro</h2>
  <p>Here's a minimal working example of this in <code>jax</code> and <code>numpyro</code></p>

  <div class="code-block">
    <button class="copy-button" type="button">Copy</button>
    <pre><code>import jax.numpy as jnp
from jax import random
from numpyro import distributions as dist

# Setup
key = random.PRNGKey(0)
num_samples = 1000  # N = 1_000
dim = 3             # d = 3

# Generate mean
key, sub = random.split(key)
mu = random.normal(sub, (dim,))

# Generate covariance
key, sub = random.split(key)
A = random.normal(sub, (dim, dim))
cov = A @ A.T   # ensure positive definite

# Generate samples directly
key, sub = random.split(key)
direct = dist.MultivariateNormal(mu, cov).sample(sub, (num_samples,))
</code></pre>
  </div>

  <h2>Reparameterized Sampling</h2>
  <p>
    To sample using the reparameterized form in Eq. \eqref{eq-2}, we compute the Cholesky decomposition of \( \Sigma\), and draw samples from the standard normal
  </p>

  <div class="code-block">
    <button class="copy-button" type="button">Copy</button>
<pre><code># Lower Cholesky factor 
L = jnp.linalg.cholesky(cov)    # (d, d)

# Generate samples with reparametrization
key, subkey = random.split(key)
z = random.normal(subkey, (num_samples, dim))   # (N, d)
reparam = mu + jnp.einsum("ij,nj->ni", L, z)
</code></pre>
  </div>

  <h2>Visual Validation</h2>
  <p>We can confirm the two methods produce equivalent samples by comparing pairwise plots (code omitted).</p>

  <figure class="post-figure narrow">
    <img src="/assets/notebooks/reparam_mvn.png"
    alt="Pairwise comparison of direct vs reparameterized samples across dimensions"
    width="1600" height="1200" loading="lazy" decoding="async">
    <figcaption>
      Figure 1. Pairwise plots show large overlap between direct and reparameterized samples.
    </figcaption>
  </figure>

  <p>
    I have found this reparametrization to be useful when fitting hierarchical Bayesian models.
  </p>
</article>

<!-- Load MathJax only if TeX is present -->
<script defer>
  (function () {
    const hasTeX = /\$[^$]+\$|\\\(|\\\[|\\begin\{.*?}/.test(document.body.innerHTML);
    if (!hasTeX) return;

    // MathJax configuration MUST be set before MathJax is loaded
    window.MathJax = {
      tex: {
        packages: { '[+]': ['ams'] }, // enables align, etc.
        tags: 'all'                   // auto-number all display math
        // tags: 'ams'                // alternative: AMS-style numbering
      }
    };

    const s = document.createElement('script');
    s.id = 'MathJax-script';
    s.async = true;
    s.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
    document.head.appendChild(s);
  })();
</script>

<!-- Copy buttons -->
<script defer>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.copy-button').forEach(btn => {
      btn.addEventListener('click', () => {
        // const code = btn.nextElementSibling.innerText;
        const code = btn.nextElementSibling.textContent;
        navigator.clipboard.writeText(code).then(() => {
          const prev = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = prev), 1500);
        }).catch(() => {
          // Fallback: select text if clipboard API fails
          const range = document.createRange();
          range.selectNodeContents(btn.nextElementSibling);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        });
      });
    });
  });
</script>
</body>
</html>
